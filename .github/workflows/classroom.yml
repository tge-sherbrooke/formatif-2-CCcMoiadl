name: Formatif F2 - Progressive Milestones
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  autograding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git tests

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pytest
        run: pip install -q pytest

      # =========================================
      # MILESTONE 1: LED Control (25 points)
      # =========================================
      - name: "Milestone 1: LED Control (25 pts)"
        id: milestone-1
        continue-on-error: true
        run: |
          echo "=============================================="
          echo "MILESTONE 1: LED Control"
          echo "=============================================="
          echo ""
          echo "Verifying: led_simple.py exists, syntax valid, RPi.GPIO import"
          echo ""
          pytest tests/test_milestone_01.py -v --tb=short
          echo "milestone_1_passed=true" >> $GITHUB_OUTPUT

      # =========================================
      # MILESTONE 2: DHT22 with Retry (35 points)
      # =========================================
      - name: "Milestone 2: DHT22 with Retry Logic (35 pts)"
        id: milestone-2
        continue-on-error: true
        run: |
          echo "=============================================="
          echo "MILESTONE 2: DHT22 with Retry Logic"
          echo "=============================================="
          echo ""
          echo "IMPORTANT: DHT22 errors are NORMAL!"
          echo "The one-wire protocol fails 10-20% of the time."
          echo "Your code MUST implement retry logic."
          echo ""
          pytest tests/test_milestone_02.py -v --tb=short
          echo "milestone_2_passed=true" >> $GITHUB_OUTPUT

      # =========================================
      # MILESTONE 3: Git Workflow (40 points)
      # =========================================
      - name: "Milestone 3: Git Workflow (40 pts)"
        id: milestone-3
        run: |
          echo "=============================================="
          echo "MILESTONE 3: Git Workflow"
          echo "=============================================="
          echo ""
          echo "Verifying: multiple commits, descriptive messages, all files present"
          echo ""
          pytest tests/test_milestone_03.py -v --tb=short

      # =========================================
      # Summary
      # =========================================
      - name: Results Summary
        if: always()
        run: |
          echo ""
          echo "=============================================="
          echo "         FORMATIF F2 - RESULTS SUMMARY       "
          echo "=============================================="
          echo ""
          echo "  Milestone 1 (25 pts): ${{ steps.milestone-1.outcome }}"
          echo "  Milestone 2 (35 pts): ${{ steps.milestone-2.outcome }}"
          echo "  Milestone 3 (40 pts): ${{ steps.milestone-3.outcome }}"
          echo ""
          echo "=============================================="
          echo ""
          echo "  Retries illimites!"
          echo "  Poussez a nouveau pour reessayer."
          echo ""
          echo "  RAPPEL: Les erreurs DHT22 sont NORMALES!"
          echo "  Votre code doit implementer une logique de retry."
          echo ""
          echo "=============================================="

      - name: Generate Step Summary
        if: always()
        run: |
          echo "## Formatif F2 - Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Milestone | Points | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1. LED Control | 25 | ${{ steps.milestone-1.outcome == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2. DHT22 with Retry | 35 | ${{ steps.milestone-2.outcome == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3. Git Workflow | 40 | ${{ steps.milestone-3.outcome == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retries illimites** - Poussez a nouveau pour reessayer!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: Les erreurs DHT22 sont normales. Votre code doit implementer une logique de retry." >> $GITHUB_STEP_SUMMARY
